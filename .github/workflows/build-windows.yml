name: Build Windows Launcher

on:
  workflow_dispatch:
    inputs:
      anki_version:
        description: 'Anki version to build (e.g., 25.09)'
        required: true
        default: '25.09'
        type: string
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  ANKI_VERSION: ${{ inputs.anki_version || '25.09' }}

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout AnkiBlur Repository
      uses: actions/checkout@v4

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-pc-windows-msvc

    - name: Install Windows Dependencies
      run: |
        # Install NSIS for Windows installer creation
        choco install nsis -y

        # Verify NSIS installation
        Get-Command makensis -ErrorAction SilentlyContinue | Out-Null
        if ($?) {
            Write-Host "NSIS installed successfully"
            & makensis /VERSION
        } else {
            Write-Host "WARNING: makensis not found in PATH"
            # Check common installation paths
            if (Test-Path "C:\Program Files (x86)\NSIS\makensis.exe") {
                Write-Host "Found NSIS at: C:\Program Files (x86)\NSIS\makensis.exe"
            }
        }

    - name: Download Anki Source
      run: |
        git clone --branch ${{ env.ANKI_VERSION }} --depth 1 https://github.com/ankitects/anki.git anki-source

    - name: Validate and Apply Patches
      shell: bash
      run: |
        chmod +x scripts/validate-and-apply-patches.sh
        ./scripts/validate-and-apply-patches.sh anki-source

    - name: Setup Build Environment
      shell: bash
      working-directory: anki-source
      run: |
        # Create version file
        echo "${{ env.ANKI_VERSION }}" > .version

        # Install UV for Python dependency management
        curl -LsSf https://astral.sh/uv/install.ps1 | powershell -c -
        echo "$env:USERPROFILE\\.local\\bin" >> $GITHUB_PATH

    - name: Extract UV binaries
      working-directory: anki-source
      shell: powershell
      run: |
        # Download UV for Windows
        New-Item -ItemType Directory -Force -Path out\extracted\uv
        Invoke-WebRequest -Uri "https://github.com/astral-sh/uv/releases/latest/download/uv-x86_64-pc-windows-msvc.zip" -OutFile "uv-windows.zip"
        Expand-Archive -Path "uv-windows.zip" -DestinationPath "out\extracted"
        # Move the uv.exe to the expected location
        Move-Item -Path "out\extracted\uv.exe" -Destination "out\extracted\uv\uv.exe" -Force

    - name: Patch Build Scripts for NSIS Path
      shell: bash
      working-directory: anki-source
      run: |
        # Patch the build_win.rs to use makensis from PATH
        if [ -f "qt/launcher/src/bin/build_win.rs" ]; then
          echo "Patching build_win.rs to use makensis from PATH..."
          # Read the file, replace the NSIS path, and write it back
          cp qt/launcher/src/bin/build_win.rs qt/launcher/src/bin/build_win.rs.bak
          # Use a simpler approach: replace the specific line
          cat qt/launcher/src/bin/build_win.rs.bak | \
            sed 's/const NSIS_PATH: &str = "C:[^"]*makensis\.exe";/const NSIS_PATH: \&str = "makensis.exe";/' \
            > qt/launcher/src/bin/build_win.rs
          echo "Patch applied. Checking changes:"
          grep "NSIS_PATH" qt/launcher/src/bin/build_win.rs
        fi

    - name: Build Launcher
      shell: bash
      working-directory: anki-source
      run: |
        echo "Building Windows launcher..."

        # Set environment variables for Windows build
        export CODESIGN=0
        export NO_COMPRESS=1

        # Add NSIS to PATH
        echo "Setting up NSIS in PATH..."
        export PATH="/c/Program Files (x86)/NSIS:$PATH"

        # Verify NSIS is accessible
        echo "Verifying NSIS installation..."
        if which makensis; then
          echo "makensis found in PATH"
          makensis //VERSION || echo "makensis version check failed"
        elif [ -f "/c/Program Files (x86)/NSIS/makensis.exe" ]; then
          echo "NSIS found at: /c/Program Files (x86)/NSIS/makensis.exe"
          /c/Program\ Files\ \(x86\)/NSIS/makensis.exe //VERSION || echo "Direct call failed"
        else
          echo "WARNING: makensis not found in expected locations"
          echo "Searching for makensis.exe..."
          find /c -name "makensis.exe" 2>/dev/null | head -5
        fi

        # Debug: Show environment
        echo "Current directory: $(pwd)"
        echo "Build script: qt/launcher/win/build.bat"
        echo "PATH: $PATH"

        # Run the Windows build script
        echo "Running build script..."
        # Convert Unix path to Windows path
        WINDOWS_SCRIPT=$(echo "qt/launcher/win/build.bat" | sed 's/\//\\/g')
        echo "Windows script path: $WINDOWS_SCRIPT"
        cmd.exe //c "set CODESIGN=0 && set NO_COMPRESS=1 && $WINDOWS_SCRIPT"

    - name: Package Artifacts
      shell: bash
      run: |
        mkdir -p artifacts
        chmod +x scripts/package-artifacts.sh
        ./scripts/package-artifacts.sh anki-source windows ${{ env.ANKI_VERSION }}

    - name: Generate Checksums
      shell: bash
      run: |
        cd artifacts
        certUtil -hashfile anki-launcher-windows.exe SHA256 > anki-launcher-windows.exe.sha256

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ankiblur-launcher-windows
        path: artifacts/
        retention-days: 30