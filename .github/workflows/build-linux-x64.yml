name: Build Linux x64 Launcher

on:
  workflow_dispatch:
    inputs:
      anki_version:
        description: 'Anki version to build (e.g., 25.09)'
        required: true
        default: '25.09'
        type: string
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build-linux-x64.yml'
      - 'patches/**'
      - 'scripts/**'
  pull_request:
    branches: [ main ]
    paths:
      - '.github/workflows/build-linux-x64.yml'
      - 'patches/**'
      - 'scripts/**'

env:
  ANKI_VERSION: ${{ inputs.anki_version || '25.09' }}

jobs:
  build-linux-x64:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout AnkiBlur Repository
      uses: actions/checkout@v4

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-unknown-linux-gnu

    - name: Install Linux Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libssl-dev \
          pkg-config \
          zstd \
          tar \
          patch

    - name: Download Anki Source
      run: |
        git clone --branch ${{ env.ANKI_VERSION }} --depth 1 https://github.com/ankitects/anki.git anki-source

    - name: Setup Linux patches
      run: |
        # Copy Linux main.py patches to expected location
        mkdir -p patches/0B_anki_qt_window
        cp patches/0B_LINUX_anki_qt_window_main/anki_qt_window_lib_main.patch \
           patches/0B_anki_qt_window/
        cp patches/0B_LINUX_anki_qt_window_main/anki_qt_window_lib64_main.patch \
           patches/0B_anki_qt_window/
        # Copy shared webview patches
        cp patches/0C_anki_qt_window_webview/anki_qt_window_lib_webview.patch \
           patches/0B_anki_qt_window/
        cp patches/0C_anki_qt_window_webview/anki_qt_window_lib64_webview.patch \
           patches/0B_anki_qt_window/

    - name: Validate and Apply Patches
      shell: bash
      run: |
        chmod +x scripts/validate-and-apply-patches.sh
        ./scripts/validate-and-apply-patches.sh anki-source

    - name: Setup Build Environment
      shell: bash
      working-directory: anki-source
      run: |
        # Create version file
        echo "${{ env.ANKI_VERSION }}" > .version

        # Install UV for Python dependency management
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Extract UV binaries
      working-directory: anki-source
      run: |
        mkdir -p out/extracted/uv
        curl -L https://github.com/astral-sh/uv/releases/latest/download/uv-x86_64-unknown-linux-gnu.tar.gz -o uv-amd64.tar.gz
        tar -xzf uv-amd64.tar.gz --strip-components=1 -C out/extracted/uv

    - name: Patch Build Script for Native-Only Build
      shell: bash
      working-directory: anki-source
      run: |
        # Replace the Linux build script with x86_64-specific version
        cat > qt/launcher/lin/build.sh << 'EOF'
        #!/bin/bash
        set -e

        # x86_64 specific build
        RUST_TARGET="x86_64-unknown-linux-gnu"
        ARCH_SUFFIX="amd64"

        # Add Rust target
        rustup target add $RUST_TARGET

        # Define output paths
        OUTPUT_DIR="../../../out/launcher"
        ANKI_VERSION=$(cat ../../../.version | tr -d '\n')
        LAUNCHER_DIR="$OUTPUT_DIR/anki-launcher-$ANKI_VERSION-linux-$ARCH_SUFFIX"

        # Clean and create output directory
        rm -rf "$LAUNCHER_DIR"
        mkdir -p "$LAUNCHER_DIR"

        # Build native binary
        cargo build -p launcher --release --target $RUST_TARGET

        # Copy binaries and support files
        TARGET_DIR=${CARGO_TARGET_DIR:-../../../target}
        # Copy launcher with architecture-specific name (expected by anki script)
        cp "$TARGET_DIR/$RUST_TARGET/release/launcher" "$LAUNCHER_DIR/launcher.amd64"
        # Copy UV with architecture-specific name
        cp "../../../out/extracted/uv/uv" "$LAUNCHER_DIR/uv.amd64"

        # Copy support files from lin directory
        for file in README.md anki.1 anki.desktop anki.png anki.xml anki.xpm install.sh uninstall.sh anki; do
            [ -f "$file" ] && cp "$file" "$LAUNCHER_DIR/" || echo "Warning: $file not found"
        done

        # Copy additional files from parent directory
        [ -f "../pyproject.toml" ] && cp ../pyproject.toml "$LAUNCHER_DIR/"
        [ -f "../../../.python-version" ] && cp ../../../.python-version "$LAUNCHER_DIR/"
        [ -f "../versions.py" ] && cp ../versions.py "$LAUNCHER_DIR/"

        # Copy patches directory for runtime patching
        mkdir -p "$LAUNCHER_DIR/patches"

        # Copy all anki_qt_window patches
        for patch in anki_qt_window_lib_main.patch anki_qt_window_lib_webview.patch \
                     anki_qt_window_lib64_main.patch anki_qt_window_lib64_webview.patch; do
            [ -f "../../../patches/0B_anki_qt_window/$patch" ] && \
                cp "../../../patches/0B_anki_qt_window/$patch" "$LAUNCHER_DIR/patches/" || \
                echo "Warning: $patch not found"
        done

        # When anki_branding.patch is created:
        # [ -f "../../../patches/0A_anki_branding/anki_branding.patch" ] && \
        #     cp ../../../patches/0A_anki_branding/anki_branding.patch "$LAUNCHER_DIR/patches/" || \
        #     echo "Warning: anki_branding.patch not found"

        # Set executable permissions
        chmod +x "$LAUNCHER_DIR/launcher.amd64" "$LAUNCHER_DIR/uv.amd64" "$LAUNCHER_DIR/anki" || true
        chmod +x "$LAUNCHER_DIR/install.sh" "$LAUNCHER_DIR/uninstall.sh" || true

        # Set proper permissions and create tarball
        chmod -R a+r "$LAUNCHER_DIR"

        ZSTD="zstd -c --long -T0 -18"
        TRANSFORM="s%^.%anki-launcher-$ANKI_VERSION-linux-$ARCH_SUFFIX%S"
        TARBALL="$OUTPUT_DIR/anki-launcher-$ANKI_VERSION-linux-$ARCH_SUFFIX.tar.zst"

        tar -I "$ZSTD" --transform "$TRANSFORM" -cf "$TARBALL" -C "$LAUNCHER_DIR" .

        echo "Build complete:"
        echo "Launcher: $LAUNCHER_DIR"
        echo "Tarball: $TARBALL"
        EOF
        chmod +x qt/launcher/lin/build.sh

    - name: Build Launcher
      shell: bash
      working-directory: anki-source
      run: |
        echo "Building Linux x64 launcher..."
        cd qt/launcher/lin
        ./build.sh

    - name: Package Artifacts
      shell: bash
      run: |
        mkdir -p artifacts
        # Copy the amd64 tarball to the expected artifact name
        cp anki-source/out/launcher/anki-launcher-${{ env.ANKI_VERSION }}-linux-amd64.tar.zst \
           artifacts/anki-launcher-linux-x86_64.tar.zst

    - name: Generate Checksums
      shell: bash
      run: |
        cd artifacts
        sha256sum anki-launcher-linux-x86_64.tar.zst > anki-launcher-linux-x86_64.tar.zst.sha256

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ankiblur-launcher-linux-x64
        path: artifacts/
        retention-days: 30