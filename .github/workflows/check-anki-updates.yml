name: check-anki-updates

on:
  schedule:
    # Check for updates daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      force_check:
        type: boolean
        description: Force check even if recently checked
        default: false

env:
  ANKI_REPO: ankitects/anki
  BLUR_REPO: ${{ github.repository }}

jobs:
  check-updates:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests PyGithub

      - name: Check for new Anki releases
        id: check-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORCE_CHECK: ${{ github.event.inputs.force_check }}
        run: |
          python scripts/check_anki_updates.py

      - name: Trigger build workflow
        if: steps.check-release.outputs.new_release == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NEW_VERSION: ${{ steps.check-release.outputs.anki_version }}
        run: |
          # Trigger the build workflow with repository dispatch
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type":"new-anki-release","client_payload":{"anki_version":"'$NEW_VERSION'"}}'

      - name: Create issue for manual review
        if: steps.check-release.outputs.needs_review == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NEW_VERSION: ${{ steps.check-release.outputs.anki_version }}
          CHANGES_URL: ${{ steps.check-release.outputs.changes_url }}
        run: |
          # Create an issue to notify about the new release
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/issues \
            -d '{
              "title": "New Anki release detected: '$NEW_VERSION'",
              "body": "A new Anki release has been detected.\n\n**Version:** '$NEW_VERSION'\n**Release Notes:** '$CHANGES_URL'\n\nPlease review the changes and determine if patches need to be updated before building AnkiBlur.\n\nTo build manually, run the build workflow with version: '$NEW_VERSION'",
              "labels": ["new-release", "review-needed"]
            }'