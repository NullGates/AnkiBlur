name: Build AnkiBlur Launchers

on:
  workflow_dispatch:
    inputs:
      anki_version:
        description: 'Anki version to build (e.g., 25.09)'
        required: true
        default: '25.09'
        type: string
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  ANKI_VERSION: ${{ inputs.anki_version || '25.09' }}

jobs:
  build-launchers:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux-x86_64
            os: ubuntu-22.04
            artifact_name: anki-launcher-linux-x86_64.tar.zst
            build_script: qt/launcher/lin/build.sh

          - platform: linux-arm64
            os: ubuntu-22.04-arm
            artifact_name: anki-launcher-linux-arm64.tar.zst
            build_script: qt/launcher/lin/build.sh

          - platform: macos
            os: macos-latest
            artifact_name: anki-launcher-mac.dmg
            build_script: qt/launcher/mac/build.sh

          - platform: windows
            os: windows-latest
            artifact_name: anki-launcher-windows.exe
            build_script: qt/launcher/win/build.bat

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout AnkiBlur Repository
      uses: actions/checkout@v4

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: |
          ${{ matrix.platform == 'linux-x86_64' && 'x86_64-unknown-linux-gnu' || '' }}
          ${{ matrix.platform == 'linux-arm64' && 'aarch64-unknown-linux-gnu' || '' }}
          ${{ matrix.platform == 'windows' && 'x86_64-pc-windows-msvc' || '' }}
          ${{ matrix.platform == 'macos' && 'aarch64-apple-darwin x86_64-apple-darwin' || '' }}

    - name: Install Linux Dependencies
      if: startsWith(matrix.platform, 'linux')
      run: |
        sudo apt-get update
        # Install native dependencies for each platform (no cross-compilation)
        sudo apt-get install -y \
          libssl-dev \
          pkg-config \
          zstd \
          tar \
          patch

    - name: Install macOS Dependencies
      if: matrix.platform == 'macos'
      run: |
        # Install any macOS specific dependencies here
        brew install zstd

    - name: Install Windows Dependencies
      if: matrix.platform == 'windows'
      run: |
        # Install NSIS for Windows installer creation
        choco install nsis -y

        # Verify NSIS installation
        Get-Command makensis -ErrorAction SilentlyContinue | Out-Null
        if ($?) {
            Write-Host "NSIS installed successfully"
            & makensis /VERSION
        } else {
            Write-Host "WARNING: makensis not found in PATH"
            # Check common installation paths
            if (Test-Path "C:\Program Files (x86)\NSIS\makensis.exe") {
                Write-Host "Found NSIS at: C:\Program Files (x86)\NSIS\makensis.exe"
            }
        }

    - name: Download Anki Source
      run: |
        git clone --branch ${{ env.ANKI_VERSION }} --depth 1 https://github.com/ankitects/anki.git anki-source

    - name: Validate and Apply Patches
      shell: bash
      run: |
        chmod +x scripts/validate-and-apply-patches.sh
        ./scripts/validate-and-apply-patches.sh anki-source

    - name: Setup Build Environment
      shell: bash
      working-directory: anki-source
      run: |
        # Create version file
        echo "${{ env.ANKI_VERSION }}" > .version

        # Install UV for Python dependency management
        if [[ "${{ matrix.platform }}" == "windows" ]]; then
          curl -LsSf https://astral.sh/uv/install.ps1 | powershell -c -
          echo "$env:USERPROFILE\\.local\\bin" >> $GITHUB_PATH
        else
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
        fi

    - name: Extract UV binaries (Linux x86_64)
      if: matrix.platform == 'linux-x86_64'
      working-directory: anki-source
      run: |
        mkdir -p out/extracted/uv
        curl -L https://github.com/astral-sh/uv/releases/latest/download/uv-x86_64-unknown-linux-gnu.tar.gz -o uv-amd64.tar.gz
        tar -xzf uv-amd64.tar.gz --strip-components=1 -C out/extracted/uv

    - name: Extract UV binaries (Linux ARM64)
      if: matrix.platform == 'linux-arm64'
      working-directory: anki-source
      run: |
        mkdir -p out/extracted/uv
        curl -L https://github.com/astral-sh/uv/releases/latest/download/uv-aarch64-unknown-linux-gnu.tar.gz -o uv-arm64.tar.gz
        tar -xzf uv-arm64.tar.gz --strip-components=1 -C out/extracted/uv

    - name: Extract UV binaries (macOS)
      if: matrix.platform == 'macos'
      working-directory: anki-source
      run: |
        # Create universal UV binary for macOS
        mkdir -p out
        curl -L https://github.com/astral-sh/uv/releases/latest/download/uv-x86_64-apple-darwin.tar.gz -o uv-x86_64.tar.gz
        curl -L https://github.com/astral-sh/uv/releases/latest/download/uv-aarch64-apple-darwin.tar.gz -o uv-aarch64.tar.gz

        tar -xzf uv-x86_64.tar.gz
        tar -xzf uv-aarch64.tar.gz

        lipo -create uv-x86_64-apple-darwin/uv uv-aarch64-apple-darwin/uv -output out/uv

    - name: Extract UV binaries (Windows)
      if: matrix.platform == 'windows'
      working-directory: anki-source
      shell: powershell
      run: |
        # Download UV for Windows
        New-Item -ItemType Directory -Force -Path out\extracted\uv
        Invoke-WebRequest -Uri "https://github.com/astral-sh/uv/releases/latest/download/uv-x86_64-pc-windows-msvc.zip" -OutFile "uv-windows.zip"
        Expand-Archive -Path "uv-windows.zip" -DestinationPath "out\extracted"
        # Move the uv.exe to the expected location
        Move-Item -Path "out\extracted\uv.exe" -Destination "out\extracted\uv\uv.exe" -Force

    - name: Patch Build Scripts for Windows NSIS Path
      if: matrix.platform == 'windows'
      shell: bash
      working-directory: anki-source
      run: |
        # Patch the build_win.rs to use makensis from PATH
        if [ -f "qt/launcher/src/bin/build_win.rs" ]; then
          echo "Patching build_win.rs to use makensis from PATH..."
          # Replace the hardcoded NSIS path with makensis.exe from PATH
          sed -i 's|const NSIS_PATH: &str = "C:\\\\Program Files (x86)\\\\NSIS\\\\makensis.exe";|const NSIS_PATH: \&str = "makensis.exe";|' qt/launcher/src/bin/build_win.rs
          echo "Patch applied successfully"
        fi

    - name: Patch Build Scripts for Native-Only Builds
      if: startsWith(matrix.platform, 'linux')
      shell: bash
      working-directory: anki-source
      run: |
        # Replace the entire Linux build script with a single-architecture version
        cat > qt/launcher/lin/build.sh << 'EOF'
        #!/bin/bash
        set -e

        # Detect host architecture
        HOST_ARCH=$(uname -m)
        if [ "$HOST_ARCH" = "x86_64" ]; then
            RUST_TARGET="x86_64-unknown-linux-gnu"
            ARCH_SUFFIX="amd64"
        else
            RUST_TARGET="aarch64-unknown-linux-gnu"
            ARCH_SUFFIX="arm64"
        fi

        # Add Rust target
        rustup target add $RUST_TARGET

        # Define output paths
        OUTPUT_DIR="../../../out/launcher"
        ANKI_VERSION=$(cat ../../../.version | tr -d '\n')
        LAUNCHER_DIR="$OUTPUT_DIR/anki-launcher-$ANKI_VERSION-linux-$ARCH_SUFFIX"

        # Clean and create output directory
        rm -rf "$LAUNCHER_DIR"
        mkdir -p "$LAUNCHER_DIR"

        # Build native binary only
        cargo build -p launcher --release --target $RUST_TARGET

        # Copy binaries and support files
        TARGET_DIR=${CARGO_TARGET_DIR:-../../../target}
        cp "$TARGET_DIR/$RUST_TARGET/release/launcher" "$LAUNCHER_DIR/launcher"
        cp "../../../out/extracted/uv/uv" "$LAUNCHER_DIR/uv"

        # Copy support files from lin directory
        for file in README.md anki.1 anki.desktop anki.png anki.xml anki.xpm install.sh uninstall.sh anki; do
            [ -f "$file" ] && cp "$file" "$LAUNCHER_DIR/" || echo "Warning: $file not found"
        done

        # Copy additional files from parent directory
        [ -f "../pyproject.toml" ] && cp ../pyproject.toml "$LAUNCHER_DIR/"
        [ -f "../../../.python-version" ] && cp ../../../.python-version "$LAUNCHER_DIR/"
        [ -f "../versions.py" ] && cp ../versions.py "$LAUNCHER_DIR/"

        # Set executable permissions
        chmod +x "$LAUNCHER_DIR/launcher" "$LAUNCHER_DIR/uv" "$LAUNCHER_DIR/anki" || true
        chmod +x "$LAUNCHER_DIR/install.sh" "$LAUNCHER_DIR/uninstall.sh" || true

        # Set proper permissions and create tarball
        chmod -R a+r "$LAUNCHER_DIR"

        ZSTD="zstd -c --long -T0 -18"
        TRANSFORM="s%^.%anki-launcher-$ANKI_VERSION-linux-$ARCH_SUFFIX%S"
        TARBALL="$OUTPUT_DIR/anki-launcher-$ANKI_VERSION-linux-$ARCH_SUFFIX.tar.zst"

        tar -I "$ZSTD" --transform "$TRANSFORM" -cf "$TARBALL" -C "$LAUNCHER_DIR" .

        echo "Build complete:"
        echo "Launcher: $LAUNCHER_DIR"
        echo "Tarball: $TARBALL"
        EOF
        chmod +x qt/launcher/lin/build.sh

    - name: Patch macOS Build Script
      if: matrix.platform == 'macos'
      shell: bash
      working-directory: anki-source
      run: |
        # Replace the macOS build script to avoid redundant builds
        cat > qt/launcher/mac/build.sh << 'EOF'
        #!/bin/bash
        set -e

        echo "Building macOS launcher..."

        # Define output path
        OUTPUT_DIR="../../../out/launcher"
        APP_LAUNCHER="$OUTPUT_DIR/Anki.app"

        # Build binaries for both architectures
        echo "Building launcher for both architectures..."
        rustup target add aarch64-apple-darwin x86_64-apple-darwin

        # Set explicit target directory
        export CARGO_TARGET_DIR="../../../target"

        cargo build -p launcher --release --target aarch64-apple-darwin
        cargo build -p launcher --release --target x86_64-apple-darwin

        # Build UV universal binary
        (cd ../../.. && ./ninja launcher:uv_universal)

        # Ensure output directory exists
        mkdir -p "$OUTPUT_DIR"

        # Remove existing app launcher
        rm -rf "$APP_LAUNCHER"

        # Create app launcher structure
        mkdir -p "$APP_LAUNCHER/Contents/MacOS" "$APP_LAUNCHER/Contents/Resources"

        # Create universal binary
        echo "Creating universal binary with lipo..."
        lipo -create \
            "$CARGO_TARGET_DIR/aarch64-apple-darwin/release/launcher" \
            "$CARGO_TARGET_DIR/x86_64-apple-darwin/release/launcher" \
            -output "$APP_LAUNCHER/Contents/MacOS/launcher"

        # Copy UV
        cp "$OUTPUT_DIR/uv" "$APP_LAUNCHER/Contents/MacOS/"

        # Build install_name_tool stub
        clang -arch arm64 -o "$OUTPUT_DIR/stub_arm64" stub.c
        clang -arch x86_64 -o "$OUTPUT_DIR/stub_x86_64" stub.c
        lipo -create "$OUTPUT_DIR/stub_arm64" "$OUTPUT_DIR/stub_x86_64" -output "$APP_LAUNCHER/Contents/MacOS/install_name_tool"
        rm "$OUTPUT_DIR/stub_arm64" "$OUTPUT_DIR/stub_x86_64"

        # Copy support files
        ANKI_VERSION=$(cat ../../../.version | tr -d '\n')
        sed "s/ANKI_VERSION/$ANKI_VERSION/g" Info.plist > "$APP_LAUNCHER/Contents/Info.plist"
        cp icon/Assets.car "$APP_LAUNCHER/Contents/Resources/"
        cp ../pyproject.toml "$APP_LAUNCHER/Contents/Resources/"
        cp ../../../.python-version "$APP_LAUNCHER/Contents/Resources/"
        cp ../versions.py "$APP_LAUNCHER/Contents/Resources/"

        # Skip codesigning if NODMG is set
        if [ -z "$NODMG" ]; then
            echo "Skipping codesigning and DMG creation (NODMG=1)"
        else
            # Codesign/bundle
            for i in "$APP_LAUNCHER/Contents/MacOS/uv" "$APP_LAUNCHER/Contents/MacOS/install_name_tool" "$APP_LAUNCHER/Contents/MacOS/launcher" "$APP_LAUNCHER"; do
                codesign --force -vvvv -o runtime -s "Developer ID Application:" \
                --entitlements entitlements.python.xml \
                "$i"
            done

            # Check
            codesign -vvv "$APP_LAUNCHER"
            spctl -a "$APP_LAUNCHER"

            # Notarize and build dmg
            ./notarize.sh "$OUTPUT_DIR"
            ./dmg/build.sh "$OUTPUT_DIR"
        fi

        echo "macOS build completed successfully!"
        EOF
        chmod +x qt/launcher/mac/build.sh

    - name: Build Launcher
      shell: bash
      working-directory: anki-source
      env:
        MACOSX_DEPLOYMENT_TARGET: ${{ matrix.platform == 'macos' && '10.15' || '' }}
        SDKROOT: ${{ matrix.platform == 'macos' && '/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk' || '' }}
        CARGO_TARGET_X86_64_APPLE_DARWIN_LINKER: ${{ matrix.platform == 'macos' && 'clang' || '' }}
        CARGO_TARGET_AARCH64_APPLE_DARWIN_LINKER: ${{ matrix.platform == 'macos' && 'clang' || '' }}
        CARGO_TARGET_DIR: ${{ matrix.platform == 'macos' && 'target' || '' }}
      run: |
        echo "Building on ${{ matrix.platform }} platform"

        if [[ "${{ matrix.platform }}" == "windows" ]]; then
          # Set environment variables for Windows build
          export CODESIGN=0
          export NO_COMPRESS=1

          # Verify NSIS installation
          echo "Checking NSIS installation..."
          if [ -f "/c/Program Files (x86)/NSIS/makensis.exe" ]; then
            echo "NSIS found at: /c/Program Files (x86)/NSIS/makensis.exe"
            export PATH="/c/Program Files (x86)/NSIS:$PATH"
            echo "NSIS added to PATH"
          else
            echo "ERROR: NSIS not found at expected location"
            echo "Checking alternative locations..."
            find /c -name "makensis.exe" 2>/dev/null | head -5 || echo "makensis.exe not found"
          fi

          # Debug: Show environment
          echo "Current directory: $(pwd)"
          echo "Build script: ${{ matrix.build_script }}"
          echo "PATH: $PATH"

          # Run the Windows build script
          echo "Running build script..."
          cmd.exe //c "set CODESIGN=0 && set NO_COMPRESS=1 && ${{ matrix.build_script }}"
        else
          # Set NODMG=1 for macOS to skip DMG creation in build script
          if [[ "${{ matrix.platform }}" == "macos" ]]; then
            export NODMG=1
          fi
          chmod +x ${{ matrix.build_script }}
          cd $(dirname ${{ matrix.build_script }})
          ./$(basename ${{ matrix.build_script }})
        fi

    - name: Create DMG (macOS only)
      if: matrix.platform == 'macos'
      working-directory: anki-source
      run: |
        # Create DMG without codesigning
        cd qt/launcher/mac/dmg
        chmod +x build.sh
        ./build.sh ../../../out/launcher

    - name: Package Artifacts
      shell: bash
      run: |
        mkdir -p artifacts

        if [[ "${{ matrix.platform }}" == "linux-x86_64" ]]; then
          # Copy the amd64 tarball to the expected artifact name
          cp anki-source/out/launcher/anki-launcher-${{ env.ANKI_VERSION }}-linux-amd64.tar.zst \
             artifacts/anki-launcher-linux-x86_64.tar.zst
        elif [[ "${{ matrix.platform }}" == "linux-arm64" ]]; then
          # Copy the arm64 tarball to the expected artifact name
          cp anki-source/out/launcher/anki-launcher-${{ env.ANKI_VERSION }}-linux-arm64.tar.zst \
             artifacts/anki-launcher-linux-arm64.tar.zst
        else
          # For other platforms, use the package script
          chmod +x scripts/package-artifacts.sh
          PACKAGE_PLATFORM="${{ matrix.platform }}"
          ./scripts/package-artifacts.sh anki-source "$PACKAGE_PLATFORM" ${{ env.ANKI_VERSION }}
        fi

    - name: Generate Checksums
      shell: bash
      run: |
        if [[ "${{ matrix.platform }}" == "windows" ]]; then
          certUtil -hashfile artifacts/${{ matrix.artifact_name }} SHA256 > artifacts/${{ matrix.artifact_name }}.sha256
        else
          cd artifacts
          sha256sum ${{ matrix.artifact_name }} > ${{ matrix.artifact_name }}.sha256
        fi

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ankiblur-launcher-${{ matrix.platform }}
        path: artifacts/
        retention-days: 30

  create-release:
    needs: build-launchers
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: release-artifacts

    - name: Combine Artifacts
      run: |
        mkdir -p final-release

        # Copy all platform artifacts to final release directory
        find release-artifacts -name "*.tar.zst" -exec cp {} final-release/ \;
        find release-artifacts -name "*.dmg" -exec cp {} final-release/ \;
        find release-artifacts -name "*.exe" -exec cp {} final-release/ \;
        find release-artifacts -name "*.sha256" -exec cp {} final-release/ \;

    - name: Create Combined Checksums
      run: |
        cd final-release

        # Create combined checksums file
        {
          echo "# AnkiBlur Launcher ${{ env.ANKI_VERSION }} - SHA256 Checksums"
          echo "# Generated on $(date -u)"
          echo ""

          for file in *.tar.zst *.dmg *.exe; do
            if [[ -f "$file" ]]; then
              if command -v sha256sum >/dev/null 2>&1; then
                sha256sum "$file"
              else
                shasum -a 256 "$file"
              fi
            fi
          done
        } > anki-launcher-${{ env.ANKI_VERSION }}-checksums.txt

    - name: Upload Combined Release Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ankiblur-launcher-release-${{ env.ANKI_VERSION }}
        path: final-release/
        retention-days: 90