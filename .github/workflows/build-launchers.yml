name: Build AnkiBlur Launchers

on:
  workflow_dispatch:
    inputs:
      anki_version:
        description: 'Anki version to build (e.g., 25.09)'
        required: true
        default: '25.09'
        type: string
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  ANKI_VERSION: ${{ inputs.anki_version || '25.09' }}

jobs:
  build-launchers:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux
            os: ubuntu-latest
            artifact_name: anki-launcher-linux.tar.zst
            build_script: qt/launcher/lin/build.sh

          - platform: macos
            os: macos-latest
            artifact_name: anki-launcher-mac.dmg
            build_script: qt/launcher/mac/build.sh

          - platform: windows
            os: windows-latest
            artifact_name: anki-launcher-windows.exe
            build_script: qt/launcher/win/build.bat

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout AnkiBlur Repository
      uses: actions/checkout@v4

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: |
          x86_64-unknown-linux-gnu
          aarch64-unknown-linux-gnu
          x86_64-pc-windows-msvc
          aarch64-apple-darwin
          x86_64-apple-darwin

    - name: Install Linux Dependencies
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-aarch64-linux-gnu \
          libc6-dev-arm64-cross \
          zstd \
          tar \
          patch

    - name: Install macOS Dependencies
      if: matrix.platform == 'macos'
      run: |
        # Install any macOS specific dependencies here
        brew install zstd

    - name: Install Windows Dependencies
      if: matrix.platform == 'windows'
      run: |
        # Install NSIS for Windows installer creation
        choco install nsis -y

    - name: Download Anki Source
      run: |
        curl -L https://github.com/ankitects/anki/archive/refs/tags/${{ env.ANKI_VERSION }}.tar.gz -o anki-source.tar.gz
        tar -xzf anki-source.tar.gz
        mv anki-${{ env.ANKI_VERSION }} anki-source

    - name: Validate and Apply Patches
      shell: bash
      run: |
        chmod +x scripts/validate-and-apply-patches.sh
        ./scripts/validate-and-apply-patches.sh anki-source

    - name: Setup Build Environment
      shell: bash
      working-directory: anki-source
      run: |
        # Create version file
        echo "${{ env.ANKI_VERSION }}" > .version

        # Install UV for Python dependency management
        if [[ "${{ matrix.platform }}" == "windows" ]]; then
          curl -LsSf https://astral.sh/uv/install.ps1 | powershell -c -
          echo "$env:USERPROFILE\\.local\\bin" >> $GITHUB_PATH
        else
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
        fi

    - name: Extract UV binaries (Linux)
      if: matrix.platform == 'linux'
      working-directory: anki-source
      run: |
        # Extract UV binaries for both architectures
        mkdir -p out/extracted/uv
        mkdir -p out/extracted/uv_lin_arm

        # Download UV binaries for cross-compilation
        curl -L https://github.com/astral-sh/uv/releases/latest/download/uv-x86_64-unknown-linux-gnu.tar.gz -o uv-amd64.tar.gz
        curl -L https://github.com/astral-sh/uv/releases/latest/download/uv-aarch64-unknown-linux-gnu.tar.gz -o uv-arm64.tar.gz

        tar -xzf uv-amd64.tar.gz --strip-components=1 -C out/extracted/uv
        tar -xzf uv-arm64.tar.gz --strip-components=1 -C out/extracted/uv_lin_arm

    - name: Extract UV binaries (macOS)
      if: matrix.platform == 'macos'
      working-directory: anki-source
      run: |
        # Create universal UV binary for macOS
        mkdir -p out
        curl -L https://github.com/astral-sh/uv/releases/latest/download/uv-x86_64-apple-darwin.tar.gz -o uv-x86_64.tar.gz
        curl -L https://github.com/astral-sh/uv/releases/latest/download/uv-aarch64-apple-darwin.tar.gz -o uv-aarch64.tar.gz

        tar -xzf uv-x86_64.tar.gz
        tar -xzf uv-aarch64.tar.gz

        lipo -create uv-x86_64-apple-darwin/uv uv-aarch64-apple-darwin/uv -output out/uv

    - name: Extract UV binaries (Windows)
      if: matrix.platform == 'windows'
      working-directory: anki-source
      shell: powershell
      run: |
        # Download UV for Windows
        New-Item -ItemType Directory -Force -Path out\extracted\uv
        Invoke-WebRequest -Uri "https://github.com/astral-sh/uv/releases/latest/download/uv-x86_64-pc-windows-msvc.zip" -OutFile "uv-windows.zip"
        Expand-Archive -Path "uv-windows.zip" -DestinationPath "out\extracted\uv"

    - name: Build Launcher
      shell: bash
      working-directory: anki-source
      run: |
        if [[ "${{ matrix.platform }}" == "windows" ]]; then
          # Set environment variables for Windows build
          export CODESIGN=0
          export NO_COMPRESS=1
          cmd.exe //C "${{ matrix.build_script }}"
        else
          # Set NODMG=1 for macOS to skip DMG creation in build script
          if [[ "${{ matrix.platform }}" == "macos" ]]; then
            export NODMG=1
          fi
          chmod +x ${{ matrix.build_script }}
          cd $(dirname ${{ matrix.build_script }})
          ./$(basename ${{ matrix.build_script }})
        fi

    - name: Create DMG (macOS only)
      if: matrix.platform == 'macos'
      working-directory: anki-source
      run: |
        # Create DMG without codesigning
        cd qt/launcher/mac/dmg
        chmod +x build.sh
        ./build.sh ../../../out/launcher

    - name: Package Artifacts
      shell: bash
      run: |
        chmod +x scripts/package-artifacts.sh
        ./scripts/package-artifacts.sh anki-source ${{ matrix.platform }} ${{ env.ANKI_VERSION }}

    - name: Generate Checksums
      shell: bash
      run: |
        if [[ "${{ matrix.platform }}" == "windows" ]]; then
          certUtil -hashfile artifacts/${{ matrix.artifact_name }} SHA256 > artifacts/${{ matrix.artifact_name }}.sha256
        else
          cd artifacts
          sha256sum ${{ matrix.artifact_name }} > ${{ matrix.artifact_name }}.sha256
        fi

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ankiblur-launcher-${{ matrix.platform }}
        path: artifacts/
        retention-days: 30

  create-release:
    needs: build-launchers
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: release-artifacts

    - name: Combine Artifacts
      run: |
        mkdir -p final-release

        # Copy all platform artifacts to final release directory
        find release-artifacts -name "*.tar.zst" -exec cp {} final-release/ \;
        find release-artifacts -name "*.dmg" -exec cp {} final-release/ \;
        find release-artifacts -name "*.exe" -exec cp {} final-release/ \;
        find release-artifacts -name "*.sha256" -exec cp {} final-release/ \;

    - name: Create Combined Checksums
      run: |
        cd final-release

        # Create combined checksums file
        {
          echo "# AnkiBlur Launcher ${{ env.ANKI_VERSION }} - SHA256 Checksums"
          echo "# Generated on $(date -u)"
          echo ""

          for file in *.tar.zst *.dmg *.exe; do
            if [[ -f "$file" ]]; then
              if command -v sha256sum >/dev/null 2>&1; then
                sha256sum "$file"
              else
                shasum -a 256 "$file"
              fi
            fi
          done
        } > anki-launcher-${{ env.ANKI_VERSION }}-checksums.txt

    - name: Upload Combined Release Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ankiblur-launcher-release-${{ env.ANKI_VERSION }}
        path: final-release/
        retention-days: 90