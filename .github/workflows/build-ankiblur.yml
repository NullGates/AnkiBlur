name: Build AnkiBlur Standalone

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      force_version:
        type: boolean
        description: Force update version
      anki_version:
        type: string
        description: Specific Anki version to build
  repository_dispatch:
    types: [new-anki-release]
  push:
    branches: [ main, master ]
    paths-ignore:
    - '**/*.md'
    - 'docs/**'
  pull_request:
    branches: [ main, master ]
    paths-ignore:
    - '**/*.md'

env:
  APP_NAME: AnkiBlur
  ANKI_REPO: ankitects/anki
  BLUR_REPO: ${{ github.repository }}
  ORG_NAME: ${{ github.repository_owner }}

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      ANKI_VERSION: ${{ env.ANKI_VERSION }}
      ANKI_COMMIT: ${{ env.ANKI_COMMIT }}
      BLUR_VERSION: ${{ env.BLUR_VERSION }}
      SHOULD_BUILD: ${{ env.SHOULD_BUILD }}
      SHOULD_DEPLOY: ${{ env.SHOULD_DEPLOY }}

    steps:
      - uses: actions/checkout@v4

      - name: Check Anki version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORCE_VERSION: ${{ github.event.inputs.force_version }}
          ANKI_VERSION_INPUT: ${{ github.event.inputs.anki_version }}
        run: |
          chmod +x scripts/check_version.sh
          ./scripts/check_version.sh

  build:
    needs: check
    if: needs.check.outputs.SHOULD_BUILD == 'yes' || github.event.inputs.force_version == 'true'

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
            output_name: ankiblur
          - os: ubuntu-24.04-arm
            platform: linux
            arch: aarch64
            output_name: ankiblur
          - os: windows-latest
            platform: windows
            arch: x86_64
            output_name: ankiblur.exe
          - os: macos-latest
            platform: macos
            arch: universal
            output_name: ankiblur

    runs-on: ${{ matrix.os }}

    env:
      ANKI_VERSION: ${{ needs.check.outputs.ANKI_VERSION }}
      ANKI_COMMIT: ${{ needs.check.outputs.ANKI_COMMIT }}
      BLUR_VERSION: ${{ needs.check.outputs.BLUR_VERSION }}
      PLATFORM: ${{ matrix.platform }}
      ARCH: ${{ matrix.arch }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            python3-dev \
            python3-venv \
            pkg-config \
            libssl-dev \
            rsync \
            curl

      - name: Install Windows dependencies
        if: matrix.platform == 'windows'
        run: |
          # Python and Node.js are already installed via setup actions
          # Rust is already installed via setup action
          echo "Windows build environment ready"

      - name: Install macOS dependencies
        if: matrix.platform == 'macos'
        run: |
          # Install additional tools if needed
          brew install rsync curl
          echo "macOS build environment ready"

      - name: Cache build dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/
            build_out/
          key: ${{ runner.os }}-${{ matrix.arch }}-build-${{ hashFiles('**/Cargo.toml', 'scripts/build_standalone.sh') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-build-

      - name: Build AnkiBlur standalone
        run: |
          chmod +x scripts/build_standalone.sh
          ./scripts/build_standalone.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ankiblur-${{ matrix.platform }}-${{ matrix.arch }}
          path: |
            dist/ankiblur*
            dist/*.tar.gz
            dist/*.zip
            dist/*.dmg
          retention-days: ${{ needs.check.outputs.SHOULD_DEPLOY == 'yes' && 30 || 7 }}

  release:
    needs: [check, build]
    if: needs.check.outputs.SHOULD_DEPLOY == 'yes'
    runs-on: ubuntu-latest
    env:
      BLUR_VERSION: ${{ needs.check.outputs.BLUR_VERSION }}
      ANKI_VERSION: ${{ needs.check.outputs.ANKI_VERSION }}

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets/

      - name: Prepare release assets
        run: |
          # Organize artifacts for release
          mkdir -p release/

          # Copy all platform builds to release directory
          find release-assets/ -type f \( -name "*.tar.gz" -o -name "*.zip" -o -name "*.dmg" \) -exec cp {} release/ \;

          # Copy standalone executables for direct download
          find release-assets/ -name "ankiblur*" -type f ! -name "*.tar.gz" ! -name "*.zip" ! -name "*.dmg" -exec cp {} release/ \;

          # List all release assets
          echo "Release assets:"
          ls -la release/

      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create release with all platform assets
          gh release create "v$BLUR_VERSION" release/* \
            --title "AnkiBlur v$BLUR_VERSION" \
            --notes "$(cat <<EOF
          # AnkiBlur v$BLUR_VERSION

          Based on Anki v$ANKI_VERSION with transparency and blur effects.

          ## Downloads

          ### Linux
          - **ankiblur-linux-x86_64.tar.gz** - Linux x64 package
          - **ankiblur-linux-aarch64.tar.gz** - Linux ARM64 package

          ### Windows
          - **ankiblur-windows-x86_64.zip** - Windows package

          ### macOS
          - **ankiblur-macos-universal.dmg** - macOS universal binary

          ## Installation

          **Linux**: Extract and run \`./install.sh\`
          **Windows**: Extract and run \`ankiblur.exe\`
          **macOS**: Mount DMG and drag AnkiBlur to Applications

          ## Features
          - âœ¨ All features of Anki v$ANKI_VERSION
          - ðŸŽ¨ Window transparency effects
          - ðŸ“¦ Standalone executable (no installation dependencies)
          - ðŸŒ Universal binaries for maximum compatibility

          ---
          ðŸ¤– Generated with [Claude Code](https://claude.ai/code)

          Co-Authored-By: Claude <noreply@anthropic.com>
          EOF
          )" || echo "Release creation failed, artifacts uploaded to workflow"

      - name: Update latest release info
        run: |
          # Update version tracking
          echo "Latest AnkiBlur release: v$BLUR_VERSION (based on Anki v$ANKI_VERSION)" > LATEST_RELEASE.md
          echo "Built on: $(date -u)" >> LATEST_RELEASE.md
          echo "Commit: ${{ github.sha }}" >> LATEST_RELEASE.md