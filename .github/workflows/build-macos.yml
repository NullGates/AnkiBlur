name: Build macOS Launcher

on:
  workflow_dispatch:
    inputs:
      anki_version:
        description: 'Anki version to build (e.g., 25.09)'
        required: true
        default: '25.09'
        type: string
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build-macos.yml'
      - 'patches/**'
      - 'scripts/**'
  pull_request:
    branches: [ main ]
    paths:
      - '.github/workflows/build-macos.yml'
      - 'patches/**'
      - 'scripts/**'

env:
  ANKI_VERSION: ${{ inputs.anki_version || '25.09' }}

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
    - name: Checkout AnkiBlur Repository
      uses: actions/checkout@v4

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-apple-darwin x86_64-apple-darwin

    - name: Install macOS Dependencies
      run: |
        brew install zstd

    - name: Download Anki Source
      run: |
        git clone --branch ${{ env.ANKI_VERSION }} --depth 1 https://github.com/ankitects/anki.git anki-source

    - name: Setup macOS patches
      run: |
        # Copy macOS main.py patches to expected location
        mkdir -p patches/0B_anki_qt_window
        cp patches/0B_MACOS_anki_qt_window_main/anki_qt_window_lib_main.patch \
           patches/0B_anki_qt_window/
        cp patches/0B_MACOS_anki_qt_window_main/anki_qt_window_lib64_main.patch \
           patches/0B_anki_qt_window/
        # Copy shared webview patches
        cp patches/0C_anki_qt_window_webview/anki_qt_window_lib_webview.patch \
           patches/0B_anki_qt_window/
        cp patches/0C_anki_qt_window_webview/anki_qt_window_lib64_webview.patch \
           patches/0B_anki_qt_window/

    - name: Validate and Apply Patches
      shell: bash
      run: |
        chmod +x scripts/validate-and-apply-patches.sh
        ./scripts/validate-and-apply-patches.sh anki-source

    - name: Setup Build Environment
      shell: bash
      working-directory: anki-source
      run: |
        # Create version file
        echo "${{ env.ANKI_VERSION }}" > .version

        # Install UV for Python dependency management
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Extract UV binaries
      working-directory: anki-source
      run: |
        # Create universal UV binary for macOS
        mkdir -p out
        curl -L https://github.com/astral-sh/uv/releases/latest/download/uv-x86_64-apple-darwin.tar.gz -o uv-x86_64.tar.gz
        curl -L https://github.com/astral-sh/uv/releases/latest/download/uv-aarch64-apple-darwin.tar.gz -o uv-aarch64.tar.gz

        tar -xzf uv-x86_64.tar.gz
        tar -xzf uv-aarch64.tar.gz

        lipo -create uv-x86_64-apple-darwin/uv uv-aarch64-apple-darwin/uv -output out/uv

    - name: Patch macOS Build Script
      shell: bash
      working-directory: anki-source
      run: |
        # Replace the macOS build script to ensure proper paths
        cat > qt/launcher/mac/build.sh << 'EOF'
        #!/bin/bash
        set -e

        echo "Building macOS launcher..."

        # Define output path
        OUTPUT_DIR="../../../out/launcher"
        APP_LAUNCHER="$OUTPUT_DIR/Anki.app"

        # Build binaries for both architectures
        echo "Building launcher for both architectures..."
        rustup target add aarch64-apple-darwin x86_64-apple-darwin

        # Set explicit target directory
        export CARGO_TARGET_DIR="../../../target"

        cargo build -p launcher --release --target aarch64-apple-darwin
        cargo build -p launcher --release --target x86_64-apple-darwin

        # Build UV universal binary
        (cd ../../.. && ./ninja launcher:uv_universal)

        # Ensure output directory exists
        mkdir -p "$OUTPUT_DIR"

        # Remove existing app launcher
        rm -rf "$APP_LAUNCHER"

        # Create app launcher structure
        mkdir -p "$APP_LAUNCHER/Contents/MacOS" "$APP_LAUNCHER/Contents/Resources"

        # Create universal binary
        echo "Creating universal binary with lipo..."
        lipo -create \
            "$CARGO_TARGET_DIR/aarch64-apple-darwin/release/launcher" \
            "$CARGO_TARGET_DIR/x86_64-apple-darwin/release/launcher" \
            -output "$APP_LAUNCHER/Contents/MacOS/launcher"

        # Copy UV
        cp "$OUTPUT_DIR/uv" "$APP_LAUNCHER/Contents/MacOS/"

        # Build install_name_tool stub
        clang -arch arm64 -o "$OUTPUT_DIR/stub_arm64" stub.c
        clang -arch x86_64 -o "$OUTPUT_DIR/stub_x86_64" stub.c
        lipo -create "$OUTPUT_DIR/stub_arm64" "$OUTPUT_DIR/stub_x86_64" -output "$APP_LAUNCHER/Contents/MacOS/install_name_tool"
        rm "$OUTPUT_DIR/stub_arm64" "$OUTPUT_DIR/stub_x86_64"

        # Copy support files
        ANKI_VERSION=$(cat ../../../.version | tr -d '\n')
        sed "s/ANKI_VERSION/$ANKI_VERSION/g" Info.plist > "$APP_LAUNCHER/Contents/Info.plist"
        cp icon/Assets.car "$APP_LAUNCHER/Contents/Resources/"
        cp ../pyproject.toml "$APP_LAUNCHER/Contents/Resources/"
        cp ../../../.python-version "$APP_LAUNCHER/Contents/Resources/"
        cp ../versions.py "$APP_LAUNCHER/Contents/Resources/"

        # Copy patches directory for runtime patching
        mkdir -p "$APP_LAUNCHER/Contents/MacOS/patches"

        # Copy all anki_qt_window patches
        for patch in anki_qt_window_lib_main.patch anki_qt_window_lib_webview.patch \
                     anki_qt_window_lib64_main.patch anki_qt_window_lib64_webview.patch; do
            [ -f "../../../patches/0B_anki_qt_window/$patch" ] && \
                cp "../../../patches/0B_anki_qt_window/$patch" "$APP_LAUNCHER/Contents/MacOS/patches/" || \
                echo "Warning: $patch not found"
        done

        # When anki_branding.patch is created:
        # [ -f "../../../patches/0A_anki_branding/anki_branding.patch" ] && \
        #     cp ../../../patches/0A_anki_branding/anki_branding.patch "$APP_LAUNCHER/Contents/MacOS/patches/" || \
        #     echo "Warning: anki_branding.patch not found"

        # Skip codesigning if NODMG is set
        if [ -n "$NODMG" ]; then
            echo "Skipping codesigning and DMG creation (NODMG is set)"
        else
            # Codesign/bundle
            for i in "$APP_LAUNCHER/Contents/MacOS/uv" "$APP_LAUNCHER/Contents/MacOS/install_name_tool" "$APP_LAUNCHER/Contents/MacOS/launcher" "$APP_LAUNCHER"; do
                codesign --force -vvvv -o runtime -s "Developer ID Application:" \
                --entitlements entitlements.python.xml \
                "$i"
            done

            # Check
            codesign -vvv "$APP_LAUNCHER"
            spctl -a "$APP_LAUNCHER"

            # Notarize and build dmg
            ./notarize.sh "$OUTPUT_DIR"
            ./dmg/build.sh "$OUTPUT_DIR"
        fi

        echo "macOS build completed successfully!"
        EOF
        chmod +x qt/launcher/mac/build.sh

    - name: Build Launcher
      shell: bash
      working-directory: anki-source
      env:
        MACOSX_DEPLOYMENT_TARGET: '10.15'
        SDKROOT: '/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk'
        CARGO_TARGET_X86_64_APPLE_DARWIN_LINKER: 'clang'
        CARGO_TARGET_AARCH64_APPLE_DARWIN_LINKER: 'clang'
        NODMG: '1'  # Skip DMG creation in build script
      run: |
        echo "Building macOS launcher..."
        cd qt/launcher/mac
        ./build.sh

    - name: Create DMG
      working-directory: anki-source
      run: |
        # Check if Anki.app exists
        if [ ! -d "out/launcher/Anki.app" ]; then
          echo "Error: Anki.app not found at out/launcher/Anki.app"
          echo "Contents of out/launcher:"
          ls -la out/launcher/ || echo "out/launcher directory not found"
          exit 1
        fi

        # Create DMG using hdiutil directly
        DMG_NAME="anki-launcher-mac.dmg"
        echo "Creating DMG: $DMG_NAME"

        # Create a temporary directory for DMG contents
        mkdir -p out/launcher/dmg_temp
        cp -R out/launcher/Anki.app out/launcher/dmg_temp/

        # Create the DMG
        hdiutil create -volname "AnkiBlur" -srcfolder out/launcher/dmg_temp -ov -format UDZO "out/launcher/$DMG_NAME"

        # Clean up
        rm -rf out/launcher/dmg_temp

        echo "DMG created successfully at out/launcher/$DMG_NAME"

    - name: Package Artifacts
      shell: bash
      run: |
        mkdir -p artifacts
        # Copy the DMG we created
        if [ -f "anki-source/out/launcher/anki-launcher-mac.dmg" ]; then
          cp anki-source/out/launcher/anki-launcher-mac.dmg artifacts/
          echo "DMG copied to artifacts"
        else
          echo "Error: DMG not found"
          echo "Contents of anki-source/out/launcher:"
          ls -la anki-source/out/launcher/ || echo "Directory not found"
          exit 1
        fi

    - name: Generate Checksums
      shell: bash
      run: |
        cd artifacts
        if [ -f "anki-launcher-mac.dmg" ]; then
          shasum -a 256 anki-launcher-mac.dmg > anki-launcher-mac.dmg.sha256
          echo "Checksum generated:"
          cat anki-launcher-mac.dmg.sha256
        else
          echo "Error: DMG not found in artifacts"
          ls -la
          exit 1
        fi

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ankiblur-launcher-macos
        path: artifacts/
        retention-days: 30